
// @fileRef create_view_lead.js 
var global_show="hide";var agent_show=$("#check_if_agent").val();if(agent_show==1){var global_agent_show="hide";}
else{var global_agent_show="show";}
$(document).ready(function(){$('body').on("click","#search_form",function(){var srchmobno=$('.srchmobno').val();var srchLeadId=$('.srchLeadId').val();if(srchmobno!=''||srchLeadId!=''){if(/^\d{10}$/.test(srchmobno)&&srchmobno!=''){global_agent_show="show";$('#leadMasterTable').DataTable().destroy();$(this).attr("disabled",false);load_data();setTimeout(function(){if(global_show=="show"){$("#lead_table_div").show();}},2500);}
else if(/^!*(\d!*){10,}$/.test(srchLeadId)&&srchLeadId!=''){global_agent_show="show";$('#leadMasterTable').DataTable().destroy();$(this).attr("disabled",false);load_data();setTimeout(function(){if(global_show=="show"){$("#lead_table_div").show();}},2500);}else{swal("Alert","Enter valid digits.","warning");$("#lead_table_div").hide();return false;}}else{swal("Alert","Please enter LeadID or Mobile No.","warning");}});$('body').on("keyup","#first_name",function(){if($(this).val().match(/[^a-zA-Z ]/g)){$(this).val($(this).val().replace(/[^a-zA-Z ]/g,""));}
$(this).val($(this).val().toUpperCase());});$('body').on("keyup","#last_name",function(){if($(this).val().match(/[^a-zA-Z. ]/g)){$(this).val($(this).val().replace(/[^a-zA-Z. ]/g,""));}
$(this).val($(this).val().toUpperCase());});});var column_sort={};function reassign_agent(emp_id,reference,agent_id){$("#agent_reassign").html("");$.ajax({url:"/tele_get_all_agents",type:"POST",beforeSend:function(){$("#agent_reassign").html('<option value="">Loading...</option>');$("#agent_reassign").attr('disabled',true);},success:function(response){$("#agent_reassign").attr('disabled',false);$("#agent_reassign").html('<option value="">Select Agent</option>');$("#agent_reassign").append(response);}});$("#agent_reassign option[value="+agent_id+"]").hide();global_agent_id=agent_id;$("#agentModal").modal('show');$('#agentModal').data('element',reference);$('#agentModal').data('empid',emp_id);}
function payment_call(lead_id){$("#txno").val('');$("#txndate").val('');$("#txn-error").hide();$("#txndate-error").hide();$("#paymentModal").modal('show');$('#paymentModal').data('lead_id',lead_id);}
function get_audit_trail(emp_id){emp_id=emp_id||'';if(emp_id){$.ajax({url:"/get_audit_trail",type:"POST",async:false,data:{emp_id:emp_id},dataType:"json",success:function(response){$("#payment_details_tbody_audit").html('');$.each(response,function(key,val){$("#payment_details_tbody_audit").append('<tr>');$("#payment_details_tbody_audit").append('<td>'+val["Dispositions"]+'</td>');$("#payment_details_tbody_audit").append('<td>'+val["Sub-dispositions"]+'</td>');$("#payment_details_tbody_audit").append('<td>'+val["date"]+'</td>');$("#payment_details_tbody_audit").append('<td>'+val["agent_name"]+'</td>');$("#payment_details_tbody_audit").append('<td>'+((val["remarks"])?val["remarks"]:'')+'</td>');$("#payment_details_tbody_audit").append('<td>'+((val["type"])?val["type"]:'AV')+'</td>');$("#payment_details_tbody_audit").append('</tr>');});$("#auditmodal").modal('show');}});}}
function retrigger_pg_link(emp_id){emp_id=emp_id||'';if(emp_id){$.ajax({url:"/tls_payment_url_send",type:"POST",async:false,data:{emp_id:emp_id},dataType:"json",success:function(response){}});}
swal({title:'Success',text:'Link Sent Successfully',type:'success',showCancelButton:false,confirmButtonText:"Ok!",closeOnConfirm:true},function(){location.reload();});}
function create_proposal(emp_id){emp_id=emp_id||'';if(emp_id){$.ajax({url:"/tele_update_ref_no_vl",type:"POST",async:false,data:{emp_id:emp_id},success:function(response){$.ajax({url:"/tls_redirect_proposal",type:"POST",async:false,data:{emp_id:emp_id},dataType:"json",success:function(response){if(response.status){location.replace('/tele_create_proposal?leadid='+response.lead_id);}}});}});}}
function load_data(data_search){$.fn.dataTable.ext.errMode='none';data_search=data_search||{};var oldExportAction=function(self,e,dt,button,config){if(button[0].className.indexOf('buttons-excel')>=0){if($.fn.dataTable.ext.buttons.excelHtml5.available(dt,config)){$.fn.dataTable.ext.buttons.excelHtml5.action.call(self,e,dt,button,config);}else{$.fn.dataTable.ext.buttons.excelFlash.action.call(self,e,dt,button,config);}}else if(button[0].className.indexOf('buttons-print')>=0){$.fn.dataTable.ext.buttons.print.action(e,dt,button,config);}};var newExportAction=function(e,dt,button,config){var self=this;var oldStart=dt.settings()[0]._iDisplayStart;dt.one('preXhr',function(e,s,data){data.start=0;data.length=2147483647;dt.one('preDraw',function(e,settings){oldExportAction(self,e,dt,button,config);dt.one('preXhr',function(e,s,data){settings._iDisplayStart=oldStart;data.start=oldStart;});setTimeout(dt.ajax.reload,0);return false;});});dt.ajax.reload();};var dataTable=$('#leadMasterTable').DataTable({dom:'Bfrtip',responsive:true,searching:false,buttons:[{extend:'excel',text:'Export<i class="fa fa-file-excel-o"></i>',titleAttr:'Excel',action:newExportAction,init:function(dt,node,config){if($("#is_admin_check").val()=='1'){if($("#is_region_check").val()!=''){config.exportOptions={orthogonal:'sort',columns:['.export_region']};}
else{config.exportOptions={orthogonal:'sort',columns:['.export_admin']};}
config.columnDefs=[{"targets":[0,34,1,2],"orderable":false,},]}else{config.exportOptions={orthogonal:'sort',columns:['.export_agent']};config.columnDefs=[{"targets":[0,10],"orderable":false,},]}},}],"processing":true,"serverSide":true,"createdRow":function(row,data,dataIndex){$(row).children(':nth-child(3)').addClass('wordallign');$(row).children(':nth-child(13)').addClass('wordallign');},"order":[],"ajax":{url:'tls_lead_tbl_ajax',type:"POST",data:function(d){d.mobno=$('[name=mobno]').val();d.sakshamid=$('[name=sakshamid]').val();d.moddate=$('[name=moddate]').val();d.issuancedate=$('[name=issuancedate]').val();d.status=$('[name=status]').val();d.location=$('[name=location]').val();d.policyNumber=$('[name=policyNumber]').val();d.axis_process_filter=$('[name=axis_process_filter]').val();d.lob=$('#check_lob').val();},complete:function(response){if(!dataTable.data().any()){$("#lead_table_div").hide();swal('No Record Found');global_show="hide";return;}
if(global_agent_show=="show"){$("#lead_table_div").show();}
global_show="show";if($("#is_admin_check").val()=='1'){dataTable.columns('.admin').visible(false);}
if(response.responseJSON!==undefined){if(response.responseJSON.data.length!=0){$('#leadgrid').show();}}}},});if($("#is_admin_check").val()=='1'){dataTable.columns('.admin').visible(false);}
dataTable.columns('.lead_column').visible(false);}
function searchTable(){search("leadMasterTable");}
function clearFilter(){$('#fullName').val('');$('#ddlCountry').val(0);$('#ddlState').val(0);search("leadMasterTable");}
function manual_search(reference){$('#leadMasterTable').DataTable().destroy();reference=reference||'';var parameters={};if(reference){if(column_sort&&column_sort['sortby']==$(reference).text()){column_sort['order']=(column_sort['order']=='desc')?'asc':'desc';}else{column_sort['sortby']=$(reference).text();column_sort['order']='asc';column_sort['number']=$(reference).data('id');}
parameters['sortby']=column_sort['sortby'];parameters['order']=column_sort['order'];parameters['number']=column_sort['number'];}
$('.search').each(function(i,obj){if($(obj).val()){var key=$(obj).attr('name');var value=$(obj).val();parameters[key]=value;}});var status=$('#status :selected').val();if(status){parameters['status']=$('#status :selected').val();}
load_data(parameters);}
$(document).ready(function(){$('body').on("keyup","input[name=issuancedate]",function(){if($(this).val().match(/[^0-9- :]/g)){$(this).val($(this).val().replace(/[^0-9- :]/g,""));}});$('input[name="issuancedate"]').val('');$.validator.addMethod('valid_mobile',function(value,element,param){var re=new RegExp('^[6-9][0-9]{9}$');return this.optional(element)||re.test(value);},'Enter valid 10 digit no starting from 6 to 9');$.validator.addMethod('valid_mobile_last_ten_digits',function(value,element,param){var str1=value;var n1=10;var newvalue=str1.substring(str1.length-n1);$(element).val(newvalue);var re=new RegExp('^[6-9][0-9]{9}$');return this.optional(element)||re.test(newvalue);},'Enter valid 10 digit no starting from 6 to 9');$.validator.addMethod('validateEmail',function(value,element,param){var reg=/^([\w-]+(?:\.[\w-]+)*)@([A-Za-z0-9_\-\.])+\.([A-Za-z]{2,4})$/;return reg.test(value);},'Please enter a valid Email Address.');$('body').on("keyup","input[name=first_name]",function(){if($(this).val().match(/[^a-zA-Z ]/g)){$(this).val($(this).val().replace(/[^a-zA-Z ]/g,""));}});$('body').on("keyup","input[name=last_name]",function(){if($(this).val().match(/[^a-zA-Z. ]/g)){$(this).val($(this).val().replace(/[^a-zA-Z. ]/g,""));}});$('body').on("keyup","#mob_no, #saksham_id, #lead_id,input[name=sakshamid],input[name=mobno]",function(){if($(this).val().match(/[^0-9]/g)){$(this).val($(this).val().replace(/[^0-9]/g,""));}});$('body').on("keyup","input[name=moddate]",function(){if($(this).val().match(/[^0-9- :]/g)){$(this).val($(this).val().replace(/[^0-9- :]/g,""));}});$('body').on("change","#salutation",function(){if($(this).val()){var gender=($(this).val()=='Mr'||$(this).val()=='Master')?'Male':'Female';$("#gender1").val(gender);}});$('body').on("change","#gender1",function(){if($(this).val()&&$(this).val()!='Transgender'){var salutation=($(this).val()=='Male')?'Mr':'Mrs';$("#salutation").val(salutation);}});$('body').on("keyup change",".search",function(){if($(this).attr('name')=='mobno'||$(this).attr('name')=='sakshamid'){if($(this).val().length<10&&$(this).val().length>0){return false;}}
if($(this).val()){$(".search").attr("disabled",true);if($(this).attr('name')!='moddate'){$('#status').attr("disabled",true);$('#location').attr("disabled",true);}
$('#leadMasterTable').DataTable().destroy();$(this).attr("disabled",false);load_data();}else{$(this).attr("disabled",false);$(".search").attr("disabled",false);$('#status').attr("disabled",false);$('#location').attr("disabled",false);}});$('body').on("change","#status,#location,#axis_process_filter",function(){$(".search").attr("disabled",true);$("[name='moddate']").attr("disabled",false);if($("#status").val()==''&&$("#location").val()==''){$(".search").attr("disabled",false);}
$('#leadMasterTable').DataTable().destroy();load_data();});$('body').on("change","#agent_reassign",function(){if($(this).val()){$("#agent-error").hide();}});$('body').on("click","#clear_filter",function(){location.reload();});$("#dob").datepicker({dateFormat:"dd-mm-yy",prevText:'<i class="fa fa-angle-left"></i>',nextText:'<i class="fa fa-angle-right"></i>',changeMonth:true,changeYear:true,yearRange:"-100Y:-18Y",maxDate:"-18Y",minDate:"-56Y +1D"});$("#txndate").datepicker({dateFormat:"dd-mm-yy",prevText:'<i class="fa fa-angle-left"></i>',nextText:'<i class="fa fa-angle-right"></i>',changeMonth:true,changeYear:true,yearRange:"-100Y:-0Y",});if($('#is_region_check').val()!=''){$('#location').val($('#is_region_check').val());$('#location').attr('disabled','disabled');}
load_data();if($('#axis_process').val()=='Outbound Call Center (OCC)'){var cust_mandetory_flag=true;}else{var cust_mandetory_flag=false;}
$.validator.addMethod('customer_id',function(value,element,param){return this.optional(element)||value.length>=8;},'Enter 9 digit customer id');$("#lead-form").validate({ignore:".ignore",rules:{lead_id:{required:true},axis_process:{required:true},salutation:{required:true},first_name:{required:true},gender1:{required:true},mob_no:{required:true,valid_mobile:true,},saksham_id:{required:cust_mandetory_flag,minlength:8,maxlength:9,customer_id:true},dob:{required:true},email:{required:true,validateEmail:true}}});});$(document).on('click','#submit_lead',function(event){event.preventDefault();$('#gender1').prop("disabled",false);if(!$("#lead-form").valid()){$('#gender1').prop("disabled",true);return false;}
$.ajax({url:"/tls_insert_lead",type:"POST",async:false,data:$("#lead-form").serialize(),dataType:"json",success:function(response){if(response){var title=(response.status)?'Success':'Warning';var type=(response.status)?'success':'warning';swal({title:title,text:response.message,type:type,showCancelButton:false,confirmButtonText:"Ok!",closeOnConfirm:true},function(){if(response.status){location.replace('/tele_create_proposal?leadid='+response.lead_id);}else{if(response.message=='Saksham id already exists'){return;}else{location.reload();}}});}}});});$(document).on('click','#agentreassign-btn',function(event){event.preventDefault();$("#agent-error").hide();if(!$("#agent_reassign").val()){$("#agent-error").show();return false;}
$.ajax({url:"/tls_reassign_agent",type:"POST",async:false,data:{"emp_id":$('#agentModal').data('empid'),"agent_id":$('#agent_reassign option:selected').val()},dataType:"json",success:function(response){if(response){$("#agentModal").modal('hide');var title=(response.status)?'Success':'Warning';var type=(response.status)?'success':'warning';swal({title:title,text:response.message,type:type,showCancelButton:false,confirmButtonText:"Ok!",closeOnConfirm:true},function(){if(response.status){var ref=$('#agentModal').data('element');var update_agent_name=$(ref).closest('td').siblings()[10];$(update_agent_name).text(response.agent_name.agent_name);$("#agent_reassign").val('');location.reload();}});}}});});$(document).on('click','#txnaction-btn',function(event){event.preventDefault();$("#txn-error").hide();$("#txndate-error").hide();if(!$("#txno").val()){$("#txn-error").show();return false;}
if(!$("#txndate").val()){$("#txndate-error").show();return false;}
$.ajax({url:"/tls_agent_policy_create",type:"POST",async:false,data:{"lead_id":$('#paymentModal').data('lead_id'),"TxRefNo":$("#txno").val(),"txndate":$("#txndate").val()},dataType:"json",success:function(response){if(response){$("#paymentModal").modal('hide');var title=(response.ErrorCode=='1')?'Success':'Warning';var type=(response.ErrorCode=='1')?'success':'warning';var message=(response.ErrorCode=='1')?'Policy Created Successfully':'Erron In Policy Creation';swal({title:title,text:message,type:type,showCancelButton:false,confirmButtonText:"Ok!",closeOnConfirm:true},function(){location.reload();});}}});});function call_function(certificate_no)
{$("#"+certificate_no).html("Please wait...");$("#"+certificate_no).attr("disabled",true);$.post("/coi_download_call",{"certificate_no":certificate_no},function(e){var obj=JSON.parse(e);$("#"+certificate_no).html("Download");$("#"+certificate_no).attr("disabled",false);if(obj.status=='success'){var a=document.createElement('a');var url=obj.url;a.href=url;a.download=url;document.body.append(a);a.click();a.remove();window.URL.revokeObjectURL(url);}else{alert("Try Again Later...");}});}
function call_function_sendmail(emp_id)
{$.post("/tls_agent_coi_mail_trigger",{"emp_id":emp_id},function(e){var obj=JSON.parse(e);if(obj.status=='success'){alert("COI Trigger Successfully");}else{alert("Try Again Later...");}});}
